---
import { reverseGeocode } from '../../lib/weather-utils';
import { buildLocationSlug } from '../../lib/slug-utils';

export const prerender = false;

const { location } = Astro.params;

// Parse lat,lon from URL
const parts = location?.split(',') || [];
if (parts.length !== 2) {
  return Astro.redirect('/');
}

const lat = parseFloat(parts[0]);
const lon = parseFloat(parts[1]);
if (isNaN(lat) || isNaN(lon)) {
  return Astro.redirect('/');
}

// Reverse geocode to get zip, city, state
const geo = await reverseGeocode(lat, lon);
if (!geo.zip) {
  return Astro.redirect('/');
}

// Detect country from state abbreviation (Canadian provinces vs US states)
const canadianProvinces = ['AB', 'BC', 'MB', 'NB', 'NL', 'NS', 'NT', 'NU', 'ON', 'PE', 'QC', 'SK', 'YT'];
const stateAbbr = geo.state.length <= 3 ? geo.state.toUpperCase() : '';
const countryCode = canadianProvinces.includes(stateAbbr) ? 'ca' : 'us';

const newUrl = buildLocationSlug(geo.zip, geo.name, geo.state, countryCode);
return Astro.redirect(newUrl, 301);
---
