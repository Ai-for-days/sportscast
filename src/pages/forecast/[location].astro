---
import { reverseGeocode } from '../../lib/weather-utils';
import { buildLocationSlug } from '../../lib/slug-utils';

export const prerender = false;

const { location } = Astro.params;

// Parse lat,lon from URL
const parts = location?.split(',') || [];
if (parts.length !== 2) {
  return Astro.redirect('/');
}

const lat = parseFloat(parts[0]);
const lon = parseFloat(parts[1]);
if (isNaN(lat) || isNaN(lon)) {
  return Astro.redirect('/');
}

// Reverse geocode to get zip, city, state â€” try multiple zoom levels
let geo = await reverseGeocode(lat, lon);
if (!geo.zip) {
  // Try higher zoom for more granular postal code data
  for (const zoom of [16, 18]) {
    try {
      const res = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=${zoom}&addressdetails=1`,
        { headers: { 'User-Agent': 'WagerOnWeather/1.0 (sports weather dashboard)' } }
      );
      if (res.ok) {
        const data = await res.json();
        if (data.address?.postcode) {
          geo = {
            ...geo,
            zip: data.address.postcode,
            name: data.address.city || data.address.town || data.address.village || geo.name,
          };
          break;
        }
      }
    } catch {}
  }
}
if (!geo.zip) {
  return Astro.redirect('/');
}

// Detect country from state abbreviation (Canadian provinces vs US states)
const canadianProvinces = ['AB', 'BC', 'MB', 'NB', 'NL', 'NS', 'NT', 'NU', 'ON', 'PE', 'QC', 'SK', 'YT'];
const stateAbbr = geo.state.length <= 3 ? geo.state.toUpperCase() : '';
const countryCode = canadianProvinces.includes(stateAbbr) ? 'ca' : 'us';

const newUrl = buildLocationSlug(geo.zip, geo.name, geo.state, countryCode);
return Astro.redirect(newUrl, 301);
---
