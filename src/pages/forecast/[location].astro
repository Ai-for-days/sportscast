---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import CurrentConditions from '../../components/forecast/CurrentConditions';
import SportsMetrics from '../../components/forecast/SportsMetrics';
import HourlyForecast from '../../components/forecast/HourlyForecast';
import DailyForecast from '../../components/forecast/DailyForecast';
import TemperatureChart from '../../components/forecast/TemperatureChart';
import PrecipChart from '../../components/forecast/PrecipChart';
import WindChart from '../../components/forecast/WindChart';
import { getForecast } from '../../lib/weather-queries';

export const prerender = false;

const { location } = Astro.params;

// Parse lat,lon from URL
let lat: number, lon: number;
const parts = location?.split(',') || [];
if (parts.length === 2) {
  lat = parseFloat(parts[0]);
  lon = parseFloat(parts[1]);
} else {
  return Astro.redirect('/');
}

if (isNaN(lat) || isNaN(lon)) {
  return Astro.redirect('/');
}

const forecast = await getForecast(lat, lon, 15);
const locationName = forecast.location.displayName || `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
---

<BaseLayout
  title={`Forecast for ${locationName}`}
  description={`15-day weather forecast and sports playability for ${locationName}. Current: ${forecast.current.tempF}Â°F, ${forecast.current.description}.`}
>
  <div class="mx-auto max-w-7xl px-4 py-6">
    <div class="mb-6">
      <nav class="text-sm text-text-muted dark:text-text-dark-muted">
        <a href="/" class="hover:text-field">Home</a>
        <span class="mx-2">/</span>
        <span>Forecast</span>
      </nav>
    </div>

    <div class="grid gap-6 lg:grid-cols-3">
      <!-- Left column: Current + Sports -->
      <div class="space-y-6 lg:col-span-2">
        <CurrentConditions client:only="react" current={forecast.current} locationName={locationName} />
        <HourlyForecast client:only="react" hourly={forecast.hourly} />
        <div class="grid gap-6 md:grid-cols-2">
          <TemperatureChart client:only="react" hourly={forecast.hourly} />
          <PrecipChart client:only="react" hourly={forecast.hourly} />
        </div>
        <WindChart client:only="react" hourly={forecast.hourly} />
      </div>

      <!-- Right column: Sports metrics + Daily -->
      <div class="space-y-6">
        <SportsMetrics client:only="react" forecast={forecast.current} />
        <DailyForecast client:only="react" daily={forecast.daily} />
        <div class="rounded-xl border border-border bg-surface p-5 shadow-sm dark:border-border-dark dark:bg-surface-dark-alt">
          <h3 class="mb-3 text-lg font-semibold text-text dark:text-text-dark">Plan a Game</h3>
          <p class="mb-4 text-sm text-text-muted dark:text-text-dark-muted">
            Need detailed game-day forecasts with probability analysis?
          </p>
          <a
            href={`/game-planner?lat=${lat}&lon=${lon}`}
            class="inline-block rounded-lg bg-field px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-field-dark"
          >
            Open Game Planner
          </a>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
