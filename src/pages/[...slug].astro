---
import BaseLayout from '../components/layout/BaseLayout.astro';
import WeatherHero from '../components/forecast/WeatherHero';
import WeatherAlerts from '../components/forecast/WeatherAlerts';
import TodaysWeather from '../components/forecast/TodaysWeather';
import TomorrowOutlook from '../components/forecast/TomorrowOutlook';
import HourlyForecast from '../components/forecast/HourlyForecast';
import DailyForecast from '../components/forecast/DailyForecast';
import SportsMetrics from '../components/forecast/SportsMetrics';
import FishingForecast from '../components/forecast/FishingForecast';
import HuntingForecast from '../components/forecast/HuntingForecast';
import TemperatureChart from '../components/forecast/TemperatureChart';
import PrecipChart from '../components/forecast/PrecipChart';
import WindChart from '../components/forecast/WindChart';
import ForecastMaps from '../components/forecast/ForecastMaps';
import AllergyOutlook from '../components/forecast/AllergyOutlook';
import {
  UVIndexCard,
  SunriseSunsetCard,
  VisibilityCard,
  HumidityCard,
  PressureCard,
  AirQualityCard,
  CloudCoverCard,
  DewPointCard,
  CloudCeilingCard,
} from '../components/forecast/WeatherDetailCards';
import { getForecast } from '../lib/weather-queries';
import { parseLocationSlug, geocodePostalCode } from '../lib/slug-utils';
import { getVenuesByCity } from '../lib/venue-data';
import { getTimeOfDay, getSkyGradient, isLightBackground } from '../lib/sky-theme';

export const prerender = false;

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

// Parse the slug to extract postal code + country
const parsed = parseLocationSlug(slugStr);
if (!parsed) {
  // Check for /forecast/lat,lon fallback format
  const coordMatch = slugStr.match(/^forecast\/([-\d.]+),([-\d.]+)$/);
  if (coordMatch) {
    // Redirect to reverse-geocode to get a proper URL with zip code
    const rLat = coordMatch[1];
    const rLon = coordMatch[2];
    try {
      const revRes = await fetch(`${Astro.url.origin}/api/reverse-geocode?lat=${rLat}&lon=${rLon}`);
      if (revRes.ok) {
        const revData = await revRes.json();
        if (revData.url && !revData.url.includes('/forecast/')) {
          return Astro.redirect(revData.url);
        }
      }
    } catch {}
  }
  return Astro.redirect('/');
}

// Geocode the postal code to get lat/lon
const geo = await geocodePostalCode(parsed.postalCode, parsed.countryCode);
if (!geo) {
  return Astro.redirect('/');
}

const { lat, lon } = geo;
const forecast = await getForecast(lat, lon, 15);
const locationName = forecast.location.displayName || `${geo.city}, ${geo.state}`;
const today = forecast.daily[0];
const tomorrow = forecast.daily[1];
const _timeOfDay = getTimeOfDay(forecast.current.time, today.sunrise, today.sunset);
const skyGradient = getSkyGradient(forecast.current.description, forecast.current.cloudCover, _timeOfDay);
const skyIsLight = isLightBackground(forecast.current.description, _timeOfDay);

// Check if this city hosts any outdoor venues
const cityVenues = getVenuesByCity(geo.city, geo.state).filter(v => v.type === 'outdoor');
const venueList = cityVenues.map(v => ({
  name: v.name,
  team: v.team || '',
  sport: v.sport === 'multi' ? '' : v.sport,
}));
---

<BaseLayout
  title={`${locationName} Weather Forecast`}
  description={`15-day weather forecast for ${locationName} ${geo.zip}. Current: ${forecast.current.tempF}°F, ${forecast.current.description}.`}
>
  <div class="mx-auto max-w-4xl px-4 py-6">
    <div class="mb-4">
      <nav class="text-sm text-text-muted dark:text-text-dark-muted">
        <a href="/" class="hover:text-field">Home</a>
        <span class="mx-2">/</span>
        <span>Forecast</span>
      </nav>
    </div>

    <div class="space-y-4">
      <!-- Weather Hero -->
      <WeatherHero client:only="react" current={forecast.current} today={today} locationName={locationName} venues={venueList} utcOffsetSeconds={forecast.utcOffsetSeconds} lat={lat} lon={lon} />

      <!-- Weather Alerts -->
      <WeatherAlerts client:only="react" alerts={forecast.alerts} />

      <!-- Today's Weather Summary -->
      <TodaysWeather client:only="react" today={today} current={forecast.current} />

      <!-- Looking Ahead — Tomorrow -->
      <TomorrowOutlook client:only="react" today={today} tomorrow={tomorrow} />


      <!-- Hourly Strip -->
      <HourlyForecast client:only="react" hourly={forecast.hourly} />

      <!-- 15-Day Forecast -->
      <DailyForecast client:only="react" daily={forecast.daily} />

      <!-- Temperature Chart -->
      <TemperatureChart client:only="react" hourly={forecast.hourly} />

      <!-- Wind (compass + chart combined) -->
      <WindChart client:only="react" hourly={forecast.hourly} current={forecast.current} />

      <!-- Precipitation (summary + chart combined) -->
      <PrecipChart client:only="react" hourly={forecast.hourly} current={forecast.current} today={today} />

      <!-- Weather Maps -->
      <ForecastMaps client:only="react" lat={lat} lon={lon} daily={forecast.daily} hourly={forecast.hourly} />

      <!-- Sun & Moon + Weather Detail Cards -->
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
        <SunriseSunsetCard client:only="react" today={today} tomorrow={tomorrow} lat={lat} lon={lon} utcOffsetSeconds={forecast.utcOffsetSeconds} skyGradient={skyGradient} isLight={skyIsLight} />
        <UVIndexCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <AirQualityCard client:only="react" airQuality={forecast.airQuality} lat={lat} lon={lon} skyGradient={skyGradient} isLight={skyIsLight} />
        <HumidityCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
      </div>

      <!-- More Weather Detail Cards -->
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
        <DewPointCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <CloudCeilingCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <VisibilityCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <PressureCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <CloudCoverCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
      </div>

      <!-- Allergy Outlook -->
      <AllergyOutlook client:only="react" allergyData={forecast.allergyData} />

      <!-- Sports Playability -->
      <SportsMetrics client:only="react" forecast={forecast.current} />

      <!-- Fishing Forecast -->
      <FishingForecast client:only="react" forecast={forecast.current} tomorrowForecast={forecast.hourly.find(h => h.time.startsWith(tomorrow.date + 'T12')) || forecast.hourly.find(h => h.time.startsWith(tomorrow.date)) || forecast.current} lat={lat} lon={lon} utcOffsetSeconds={forecast.utcOffsetSeconds} today={today.date} tomorrowDate={tomorrow.date} state={geo.state} />

      <!-- Hunting Forecast -->
      <HuntingForecast client:only="react" forecast={forecast.current} tomorrowForecast={forecast.hourly.find(h => h.time.startsWith(tomorrow.date + 'T12')) || forecast.hourly.find(h => h.time.startsWith(tomorrow.date)) || forecast.current} lat={lat} lon={lon} utcOffsetSeconds={forecast.utcOffsetSeconds} today={today.date} tomorrowDate={tomorrow.date} state={geo.state} />
    </div>
  </div>
</BaseLayout>
