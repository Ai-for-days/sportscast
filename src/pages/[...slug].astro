---
import BaseLayout from '../components/layout/BaseLayout.astro';
import Breadcrumbs from '../components/layout/Breadcrumbs.astro';
import WeatherHero from '../components/forecast/WeatherHero';
import WeatherAlerts from '../components/forecast/WeatherAlerts';
import TodaysWeather from '../components/forecast/TodaysWeather';
import TomorrowOutlook from '../components/forecast/TomorrowOutlook';
import HourlyForecast from '../components/forecast/HourlyForecast';
import DailyForecast from '../components/forecast/DailyForecast';
import SportsMetrics from '../components/forecast/SportsMetrics';
import FishingForecast from '../components/forecast/FishingForecast';
import HuntingForecast from '../components/forecast/HuntingForecast';
import TemperatureChart from '../components/forecast/TemperatureChart';
import PrecipChart from '../components/forecast/PrecipChart';
import WindChart from '../components/forecast/WindChart';
import ForecastMaps from '../components/forecast/ForecastMaps';
import AllergyOutlook from '../components/forecast/AllergyOutlook';
import LocalContent from '../components/forecast/LocalContent.astro';
import WeatherOverview from '../components/forecast/WeatherOverview.astro';
import {
  UVIndexCard,
  SunriseSunsetCard,
  VisibilityCard,
  HumidityCard,
  PressureCard,
  AirQualityCard,
  CloudCoverCard,
  DewPointCard,
  CloudCeilingCard,
} from '../components/forecast/WeatherDetailCards';
import { getForecast } from '../lib/weather-queries';
import { parseLocationSlug, geocodePostalCode } from '../lib/slug-utils';
import { stateAbbrToSlug } from '../lib/state-names';
import { getVenuesByCity } from '../lib/venue-data';
import { getTimeOfDay, getSkyGradient, isLightBackground } from '../lib/sky-theme';
import { getLocationMeta } from '../lib/seo-meta';
import {
  getBreadcrumbSchema,
  getPlaceSchema,
  getSpecialAnnouncementSchema,
  getFAQSchema,
} from '../lib/schema-markup';

export const prerender = false;

const { slug } = Astro.params;
const slugStr = Array.isArray(slug) ? slug.join('/') : (slug || '');

// Parse the slug to extract postal code + country
const parsed = parseLocationSlug(slugStr);
if (!parsed) {
  // Check for /forecast/lat,lon fallback format
  const coordMatch = slugStr.match(/^forecast\/([-\d.]+),([-\d.]+)$/);
  if (coordMatch) {
    // Redirect to reverse-geocode to get a proper URL with zip code
    const rLat = coordMatch[1];
    const rLon = coordMatch[2];
    try {
      const revRes = await fetch(`${Astro.url.origin}/api/reverse-geocode?lat=${rLat}&lon=${rLon}`);
      if (revRes.ok) {
        const revData = await revRes.json();
        if (revData.url && !revData.url.includes('/forecast/')) {
          return Astro.redirect(revData.url);
        }
      }
    } catch {}
  }
  return Astro.redirect('/');
}

// Geocode the postal code to get lat/lon
const geo = await geocodePostalCode(parsed.postalCode, parsed.countryCode);
if (!geo) {
  return Astro.redirect('/');
}

const { lat, lon } = geo;
const forecast = await getForecast(lat, lon, 15);
const locationName = `${geo.city}, ${geo.state}`;
const locationLabel = `${geo.city}, ${geo.state} ${geo.zip}`;
const today = forecast.daily[0];
const tomorrow = forecast.daily[1];
const _timeOfDay = getTimeOfDay(forecast.current.time, today.sunrise, today.sunset);
const skyGradient = getSkyGradient(forecast.current.description, forecast.current.cloudCover, _timeOfDay);
const skyIsLight = isLightBackground(forecast.current.description, _timeOfDay);

// Check if this city hosts any outdoor venues
const cityVenues = getVenuesByCity(geo.city, geo.state).filter(v => v.type === 'outdoor');
const venueList = cityVenues.map(v => ({
  name: v.name,
  team: v.team || '',
  sport: v.sport === 'multi' ? '' : v.sport,
}));

// SEO meta
const seoMeta = getLocationMeta({
  city: geo.city,
  state: geo.state,
  zip: geo.zip,
  tempF: forecast.current.tempF,
  description: forecast.current.description,
  highF: today.highF,
  lowF: today.lowF,
  precipChance: today.precipProbability,
  alerts: forecast.alerts,
});

// Schema markup
const pageUrl = Astro.url.pathname;
const stateSlug = stateAbbrToSlug(geo.state.length <= 3 ? geo.state : geo.state.toLowerCase().replace(/\s+/g, '-'));
const schemas: object[] = [
  getBreadcrumbSchema([
    { name: 'Home', url: '/' },
    { name: `${geo.state} Weather`, url: `/weather/${stateSlug}` },
    { name: `${geo.city}, ${geo.state} Weather`, url: pageUrl },
  ]),
  getPlaceSchema({
    city: geo.city,
    state: geo.state,
    zip: geo.zip,
    lat,
    lon,
    tempF: forecast.current.tempF,
    description: forecast.current.description,
    humidity: forecast.current.humidity,
    windSpeedMph: forecast.current.windSpeedMph,
    url: pageUrl,
  }),
  getFAQSchema({
    city: geo.city,
    state: geo.state,
    tempF: forecast.current.tempF,
    description: forecast.current.description,
    precipChance: today.precipProbability,
    highF: today.highF,
    lowF: today.lowF,
    humidity: forecast.current.humidity,
    windSpeedMph: forecast.current.windSpeedMph,
    feelsLikeF: forecast.current.feelsLikeF,
    uvIndex: forecast.current.uvIndex,
    sunrise: today.sunrise,
    sunset: today.sunset,
  }),
];

// Add SpecialAnnouncement for active alerts
if (forecast.alerts && forecast.alerts.length > 0) {
  const alert = forecast.alerts[0];
  schemas.push(getSpecialAnnouncementSchema({
    event: alert.event,
    headline: alert.headline || alert.event,
    description: alert.description || '',
    onset: alert.onset,
    expires: alert.expires,
    city: geo.city,
    state: geo.state,
    url: pageUrl,
  }));
}
---

<BaseLayout
  title={seoMeta.title}
  description={seoMeta.description}
  jsonLd={schemas}
>
  <div class="mx-auto max-w-4xl px-4 py-6">
    <div class="mb-4">
      <Breadcrumbs items={[{ label: 'Home', href: '/' }, { label: `${geo.state} Weather`, href: `/weather/${stateSlug}` }, { label: `${geo.city}, ${geo.state} Weather` }]} />
    </div>

    <div class="space-y-4">
      <!-- Weather Hero -->
      <WeatherHero client:only="react" current={forecast.current} today={today} locationName={locationName} zip={geo.zip} venues={venueList} utcOffsetSeconds={forecast.utcOffsetSeconds} lat={lat} lon={lon} />

      <!-- Weather Alerts -->
      <WeatherAlerts client:only="react" alerts={forecast.alerts} />

      <!-- Weather Overview (SSR — featured snippet targeting) -->
      <WeatherOverview
        city={geo.city}
        state={geo.state}
        tempF={forecast.current.tempF}
        feelsLikeF={forecast.current.feelsLikeF}
        description={forecast.current.description}
        highF={today.highF}
        lowF={today.lowF}
        precipChance={today.precipProbability}
        humidity={forecast.current.humidity}
        windSpeedMph={forecast.current.windSpeedMph}
        uvIndex={forecast.current.uvIndex}
      />

      <!-- Today's Weather Summary -->
      <TodaysWeather client:only="react" today={today} current={forecast.current} />

      <!-- Looking Ahead — Tomorrow -->
      <TomorrowOutlook client:only="react" today={today} tomorrow={tomorrow} />


      <!-- Hourly Strip -->
      <HourlyForecast client:only="react" hourly={forecast.hourly} locationName={locationLabel} />

      <!-- Temperature Trend -->
      <TemperatureChart client:only="react" hourly={forecast.hourly} locationName={locationLabel} />

      <!-- 15-Day Forecast -->
      <DailyForecast client:only="react" daily={forecast.daily} locationName={locationLabel} />

      <!-- Wind (compass + chart combined) -->
      <WindChart client:only="react" hourly={forecast.hourly} current={forecast.current} locationName={locationLabel} />

      <!-- Precipitation (summary + chart combined) -->
      <PrecipChart client:only="react" hourly={forecast.hourly} current={forecast.current} today={today} locationName={locationLabel} />

      <!-- Weather Maps -->
      <ForecastMaps client:only="react" lat={lat} lon={lon} daily={forecast.daily} hourly={forecast.hourly} />

      <!-- Sun & Moon + Weather Detail Cards -->
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
        <SunriseSunsetCard client:only="react" today={today} tomorrow={tomorrow} lat={lat} lon={lon} utcOffsetSeconds={forecast.utcOffsetSeconds} skyGradient={skyGradient} isLight={skyIsLight} />
        <UVIndexCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <AirQualityCard client:only="react" airQuality={forecast.airQuality} lat={lat} lon={lon} skyGradient={skyGradient} isLight={skyIsLight} />
        <HumidityCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
      </div>

      <!-- More Weather Detail Cards -->
      <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 sm:gap-4">
        <DewPointCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <CloudCeilingCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <VisibilityCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <PressureCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
        <CloudCoverCard client:only="react" current={forecast.current} skyGradient={skyGradient} isLight={skyIsLight} />
      </div>

      <!-- Allergy Outlook -->
      <AllergyOutlook client:only="react" allergyData={forecast.allergyData} locationName={locationLabel} />

      <!-- Local Content (SSR — no JS) -->
      <LocalContent
        city={geo.city}
        state={geo.state}
        zip={geo.zip}
        lat={lat}
        lon={lon}
        currentTempF={forecast.current.tempF}
        currentDescription={forecast.current.description}
        precipProbability={today.precipProbability}
        windSpeedMph={forecast.current.windSpeedMph}
      />

      <!-- Sports Playability -->
      <SportsMetrics client:only="react" forecast={forecast.current} />

      <!-- Fishing Forecast -->
      <FishingForecast client:only="react" forecast={forecast.current} tomorrowForecast={forecast.hourly.find(h => h.time.startsWith(tomorrow.date + 'T12')) || forecast.hourly.find(h => h.time.startsWith(tomorrow.date)) || forecast.current} lat={lat} lon={lon} utcOffsetSeconds={forecast.utcOffsetSeconds} today={today.date} tomorrowDate={tomorrow.date} state={geo.state} locationName={locationLabel} />

      <!-- Hunting Forecast -->
      <HuntingForecast client:only="react" forecast={forecast.current} tomorrowForecast={forecast.hourly.find(h => h.time.startsWith(tomorrow.date + 'T12')) || forecast.hourly.find(h => h.time.startsWith(tomorrow.date)) || forecast.current} lat={lat} lon={lon} utcOffsetSeconds={forecast.utcOffsetSeconds} today={today.date} tomorrowDate={tomorrow.date} state={geo.state} locationName={locationLabel} />
    </div>
  </div>
</BaseLayout>
