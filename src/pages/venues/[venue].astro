---
import { getVenueById } from '../../lib/venue-data';
import { reverseGeocode } from '../../lib/weather-utils';
import { buildLocationSlug } from '../../lib/slug-utils';

export const prerender = false;

const { venue: venueId } = Astro.params;
const venue = getVenueById(venueId || '');

if (!venue) {
  return Astro.redirect('/venues');
}

// Reverse geocode venue coordinates to get postal code
const geo = await reverseGeocode(venue.lat, venue.lon);

if (!geo.zip) {
  // International venue without a recognized postal code â€” redirect home
  return Astro.redirect('/');
}

// Detect country
const canadianProvinces = ['AB', 'BC', 'MB', 'NB', 'NL', 'NS', 'NT', 'NU', 'ON', 'PE', 'QC', 'SK', 'YT'];
const stateAbbr = (geo.state || venue.state).length <= 3 ? (geo.state || venue.state).toUpperCase() : '';
const countryCode = canadianProvinces.includes(stateAbbr) ? 'ca' : 'us';

const newUrl = buildLocationSlug(geo.zip, geo.name || venue.city, geo.state || venue.state, countryCode);
return Astro.redirect(newUrl, 301);
---
