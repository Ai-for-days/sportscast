---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import { venues, getVenuesByLeague } from '../../lib/venue-data';
import type { Venue } from '../../lib/types';

export function getStaticPaths() {
  return [
    { params: { league: 'mlb' } },
    { params: { league: 'nfl' } },
    { params: { league: 'ncaa-football' } },
    { params: { league: 'mls' } },
    { params: { league: 'community' } },
  ];
}

const { league } = Astro.params;

const leagueMeta: Record<string, { name: string; description: string }> = {
  mlb: { name: 'MLB', description: 'All 30 Major League Baseball stadiums with live weather forecasts.' },
  nfl: { name: 'NFL', description: 'All 32 NFL stadiums with live weather forecasts.' },
  'ncaa-football': { name: 'NCAA Football', description: 'College football stadiums across every major conference.' },
  mls: { name: 'MLS & Soccer', description: 'MLS stadiums, NWSL venues, and international soccer venues.' },
  community: { name: 'Community Fields', description: 'Community parks, spring training, minor league, and youth fields.' },
};

const meta = leagueMeta[league!] || { name: league, description: '' };
const leagueVenues = getVenuesByLeague(league!);

// Group by conference, then division
const grouped = new Map<string, Map<string, Venue[]>>();
for (const v of leagueVenues) {
  const conf = v.conference || 'Other';
  const div = v.division || 'Other';
  if (!grouped.has(conf)) grouped.set(conf, new Map());
  const confMap = grouped.get(conf)!;
  if (!confMap.has(div)) confMap.set(div, []);
  confMap.get(div)!.push(v);
}

// Sort conferences
const sortedConfs = [...grouped.entries()].sort(([a], [b]) => a.localeCompare(b));

const typeIcons: Record<string, string> = {
  outdoor: 'üèüÔ∏è',
  indoor: 'üè¢',
  retractable: 'üîÑ',
};

export const prerender = true;
---

<BaseLayout title={`${meta.name} Venues`} description={meta.description}>
  <div class="mx-auto max-w-7xl px-4 py-6">
    <div class="mb-6">
      <nav class="text-sm text-text-muted dark:text-text-dark-muted">
        <a href="/" class="hover:text-field">Home</a>
        <span class="mx-2">/</span>
        <a href="/venues" class="hover:text-field">Venues</a>
        <span class="mx-2">/</span>
        <span>{meta.name}</span>
      </nav>
      <h1 class="mt-2 text-3xl font-bold text-text dark:text-text-dark">{meta.name} Venues</h1>
      <p class="mt-1 text-text-muted dark:text-text-dark-muted">
        {meta.description} <span class="font-medium">{leagueVenues.length} venues</span>
      </p>
    </div>

    <!-- Search filter -->
    <div class="mb-8">
      <div class="relative max-w-md">
        <svg class="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          id="venue-search"
          placeholder={`Search ${meta.name} venues...`}
          class="w-full rounded-lg border border-border bg-surface py-2 pl-9 pr-4 text-sm outline-none focus:border-field dark:border-border-dark dark:bg-surface-dark-alt dark:text-text-dark"
        />
      </div>
    </div>

    {sortedConfs.map(([conference, divisions]) => (
      <div class="mb-10" data-conference={conference}>
        <h2 class="mb-4 text-xl font-bold text-text dark:text-text-dark">{conference}</h2>
        {[...divisions.entries()].sort(([a], [b]) => a.localeCompare(b)).map(([division, divVenues]) => (
          <div class="mb-6">
            {division !== conference && (
              <h3 class="mb-3 text-sm font-semibold uppercase tracking-wider text-text-muted dark:text-text-dark-muted">
                {division}
              </h3>
            )}
            <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
              {divVenues.sort((a, b) => a.name.localeCompare(b.name)).map(venue => (
                <a
                  href={`/venues/${venue.id}`}
                  class="venue-card group rounded-xl border border-border bg-surface p-4 shadow-sm transition-all hover:shadow-md dark:border-border-dark dark:bg-surface-dark-alt"
                  data-name={venue.name.toLowerCase()}
                  data-city={venue.city.toLowerCase()}
                  data-state={venue.state.toLowerCase()}
                >
                  <div class="mb-1 flex items-start justify-between">
                    <span class="text-sm font-semibold text-text group-hover:text-field dark:text-text-dark dark:group-hover:text-field-light">
                      {venue.name}
                    </span>
                    <span class="ml-2 text-base">{typeIcons[venue.type]}</span>
                  </div>
                  <p class="text-xs text-text-muted dark:text-text-dark-muted">
                    {venue.city}, {venue.state}
                  </p>
                  <div class="mt-2 flex items-center gap-2">
                    <span class="text-xs text-text-muted dark:text-text-dark-muted">
                      {venue.capacity > 0 ? `${venue.capacity.toLocaleString()} seats` : ''}
                    </span>
                  </div>
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
    ))}
  </div>
</BaseLayout>

<script>
  const input = document.getElementById('venue-search') as HTMLInputElement;
  const cards = document.querySelectorAll('.venue-card') as NodeListOf<HTMLElement>;

  input?.addEventListener('input', () => {
    const q = input.value.toLowerCase().trim();
    cards.forEach(card => {
      if (!q) {
        card.style.display = '';
        return;
      }
      const name = card.dataset.name || '';
      const city = card.dataset.city || '';
      const state = card.dataset.state || '';
      const match = name.includes(q) || city.includes(q) || state.includes(q);
      card.style.display = match ? '' : 'none';
    });
  });
</script>
